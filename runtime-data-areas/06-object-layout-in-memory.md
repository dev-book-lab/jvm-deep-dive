# Object Layout In Memory - ë©”ëª¨ë¦¬ìƒ ê°ì²´ ë ˆì´ì•„ì›ƒ

---

## ğŸ¯ í•µì‹¬ ì§ˆë¬¸

ì´ ë¬¸ì„œë¥¼ ì½ê³  ë‚˜ë©´ ë‹¤ìŒ ì§ˆë¬¸ì— ë‹µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- JVMì—ì„œ ê°ì²´ëŠ” ë©”ëª¨ë¦¬ì— ì •í™•íˆ ì–´ë–¤ êµ¬ì¡°ë¡œ ì €ì¥ë˜ëŠ”ê°€?
- Object Header, Instance Data, Paddingì€ ê°ê° ë¬´ì—‡ì„ ì €ì¥í•˜ëŠ”ê°€?
- Mark WordëŠ” ì–´ë–»ê²Œ Lock ìƒíƒœì™€ GC Ageë¥¼ ë™ì‹œì— ì €ì¥í•˜ëŠ”ê°€?
- ì™œ ë¹ˆ ê°ì²´(`new Object()`)ë„ 16ë°”ì´íŠ¸ë¥¼ ì°¨ì§€í•˜ëŠ”ê°€?
- JOL(Java Object Layout) ë„êµ¬ë¡œ ì‹¤ì œ ê°ì²´ í¬ê¸°ë¥¼ ì–´ë–»ê²Œ ì¸¡ì •í•˜ëŠ”ê°€?

---

## ğŸ” ì™œ ì´ê²Œ ì¡´ì¬í•˜ëŠ”ê°€

### ë¬¸ì œ: ê°ì²´ëŠ” ë‹¨ìˆœí•œ í•„ë“œ ëª¨ìŒì´ ì•„ë‹ˆë‹¤

```java
class Point {
    int x;
    int y;
}

Point p = new Point();
```

```
ìˆœì§„í•œ ìƒê°:
  x = 4 bytes (int)
  y = 4 bytes (int)
  â†’ ì´ 8 bytes?

ì‹¤ì œ:
  $ java -jar jol.jar Point
  
  Point object internals:
  OFFSET  SIZE   TYPE    FIELD
       0    12          (object header)
      12     4   int    x
      16     4   int    y
      20     4          (loss due to alignment)
  Instance size: 24 bytes
  
  ì™œ 24ë°”ì´íŠ¸?
```

JVMì€ ê°ì²´ì— **ë©”íƒ€ë°ì´í„°**ë¥¼ í•¨ê»˜ ì €ì¥í•œë‹¤.

---

## ğŸ“ ë‚´ë¶€ êµ¬ì¡°

### 1. ê°ì²´ ë©”ëª¨ë¦¬ ë ˆì´ì•„ì›ƒ ì „ì²´ êµ¬ì¡°

```
64ë¹„íŠ¸ JVM ê¸°ì¤€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Object Header (12 bytes)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Mark Word (8 bytes)                    â”‚
â”‚  - Hash code                            â”‚
â”‚  - GC age                               â”‚
â”‚  - Lock state                           â”‚
â”‚  - Biased lock thread ID                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Class Pointer (4 bytes, compressed)    â”‚
â”‚  - Klass* ë©”íƒ€ë°ì´í„° ì£¼ì†Œ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Instance Data                   â”‚
â”‚  - ì‹¤ì œ í•„ë“œ ê°’ë“¤                          â”‚
â”‚  - íƒ€ì… ìˆœì„œ: long/double â†’ int/float     â”‚
â”‚              â†’ short/char â†’ byte/booleanâ”‚
â”‚              â†’ reference                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Padding (0~7 bytes)             â”‚
â”‚  - 8ë°”ì´íŠ¸ ì •ë ¬ (alignment)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ë°°ì—´ì¸ ê²½ìš°:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Object Header (12 bytes)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Mark Word (8 bytes)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Class Pointer (4 bytes)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Array Length (4 bytes)  â† ë°°ì—´ë§Œ ì¶”ê°€     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Array Elements                         â”‚
â”‚  [0] [1] [2] ...                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Padding                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. Mark Word ìƒì„¸ êµ¬ì¡°

```
Mark Word (64ë¹„íŠ¸):

Normal (Unlocked):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ unused:25 | hash:31 | unused:1 | age:4 | biased:0 | lock:01    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€ 25ë¹„íŠ¸  â””â”€ 31ë¹„íŠ¸  â””â”€ 1ë¹„íŠ¸  â””â”€ 4ë¹„íŠ¸ â””â”€ 1ë¹„íŠ¸  â””â”€ 2ë¹„íŠ¸

Biased Locking:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ thread_id:54 | epoch:2 | unused:1 | age:4 | biased:1 | lock:01 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€ 54ë¹„íŠ¸      â””â”€ 2ë¹„íŠ¸   â””â”€ 1ë¹„íŠ¸    â””â”€ 4ë¹„íŠ¸ â””â”€ 1ë¹„íŠ¸    â””â”€ 2ë¹„íŠ¸

Lightweight Locking:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ptr_to_lock_record:62                           | lock:00      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€ 62ë¹„íŠ¸ (Lock Record ì£¼ì†Œ)                       â””â”€ 2ë¹„íŠ¸

Heavyweight Locking:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ptr_to_heavyweight_monitor:62                   | lock:10      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€ 62ë¹„íŠ¸ (ObjectMonitor ì£¼ì†Œ)                     â””â”€ 2ë¹„íŠ¸

GC Marked:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ forwarding_address:62                           | lock:11     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€ 62ë¹„íŠ¸ (ìƒˆ ì£¼ì†Œ, Compaction ì‹œ)                  â””â”€ 2ë¹„íŠ¸

ë¹„íŠ¸ í•„ë“œ:
  hash:     hashCode() ê°’ (ì§€ì—° ìƒì„±)
  age:      Young GC ìƒì¡´ íšŸìˆ˜ (0~15)
  biased:   Biased Lock ì—¬ë¶€
  lock:     Lock ìƒíƒœ (00=Thin, 01=Unlocked/Biased, 10=Fat, 11=GC)
```

---

### 3. Class Pointer (Klass Word)

```
Compressed Oops í™œì„±í™” ì‹œ (-XX:+UseCompressedOops, ê¸°ë³¸):

4 bytes Class Pointer
â†’ 32ë¹„íŠ¸ ì˜¤í”„ì…‹ Ã— 8ë°° = 35ë¹„íŠ¸ ì£¼ì†Œ ê³µê°„
â†’ ìµœëŒ€ 32GB í™ê¹Œì§€ ì••ì¶• ê°€ëŠ¥

ì••ì¶• í•´ì œ ê³µì‹:
  ì‹¤ì œ ì£¼ì†Œ = base + (compressed_oop << 3)
  
ì˜ˆ:
  compressed = 0x12345678
  base       = 0x700000000
  ì‹¤ì œ ì£¼ì†Œ  = 0x700000000 + (0x12345678 << 3)
             = 0x70091A2BC0

í™ > 32GB:
  -XX:-UseCompressedOops ìë™ ë¹„í™œì„±í™”
  â†’ Class Pointer 8 bytes
  â†’ Object Header 16 bytes (12 â†’ 16)
```

---

### 4. Instance Data í•„ë“œ ìˆœì„œ

```
í•„ë“œ ì •ë ¬ ê·œì¹™ (HotSpot):

1. íƒ€ì…ë³„ ê·¸ë£¹í™” (í° ê²ƒë¶€í„°):
   long / double (8 bytes)
   int / float   (4 bytes)
   short / char  (2 bytes)
   byte / boolean (1 byte)
   reference    (4 bytes, compressed)

2. ìƒì† ê³ ë ¤:
   ë¶€ëª¨ í´ë˜ìŠ¤ í•„ë“œ ë¨¼ì €
   ìì‹ í´ë˜ìŠ¤ í•„ë“œ ë‚˜ì¤‘

ì˜ˆ:
class Parent {
    int a;      // 4
    byte b;     // 1
}

class Child extends Parent {
    long c;     // 8
    int d;      // 4
}

Child ê°ì²´:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Object Header  â”‚ 12
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parent.a (int) â”‚ 12~16  (ë¶€ëª¨ í•„ë“œ)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parent.b (byte)â”‚ 16~17
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (padding)      â”‚ 17~20  (ì •ë ¬)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Child.c (long) â”‚ 20~28  (ìì‹ í•„ë“œ, 8ë°”ì´íŠ¸ ì •ë ¬)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Child.d (int)  â”‚ 28~32
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total: 32 bytes
```

---

### 5. Paddingê³¼ 8ë°”ì´íŠ¸ ì •ë ¬

```
ì™œ 8ë°”ì´íŠ¸ ì •ë ¬?

1. CPU ë©”ëª¨ë¦¬ ì ‘ê·¼ íš¨ìœ¨
   64ë¹„íŠ¸ CPUëŠ” 8ë°”ì´íŠ¸ ê²½ê³„ì—ì„œ ì½ê¸° ìµœì í™”
   ì •ë ¬ë˜ì§€ ì•Šì€ ì£¼ì†Œ â†’ ì—¬ëŸ¬ ë²ˆ ì½ê¸° í•„ìš”

2. í¬ì¸í„° ì••ì¶• (Compressed Oops)
   ì£¼ì†Œ í•˜ìœ„ 3ë¹„íŠ¸ê°€ í•­ìƒ 000
   â†’ 3ë¹„íŠ¸ ì ˆì•½ â†’ 32ë¹„íŠ¸ë¡œ 35ë¹„íŠ¸ í‘œí˜„ ê°€ëŠ¥

ì˜ˆ:
class Tiny {
    byte b;
}

Tiny ê°ì²´:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Object Header  â”‚ 12
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ b (byte)       â”‚ 12~13
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (padding)      â”‚ 13~16  â† 3ë°”ì´íŠ¸ ë‚­ë¹„
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Total: 16 bytes (8ì˜ ë°°ìˆ˜ë¡œ ì •ë ¬)
```

---

## ğŸ’» ì‹¤í—˜ìœ¼ë¡œ í™•ì¸í•˜ê¸°

### ì‹¤í—˜ 1: JOLë¡œ ê°ì²´ í¬ê¸° ì¸¡ì •

```java
// pom.xmlì— JOL ì˜ì¡´ì„± ì¶”ê°€
// <dependency>
//   <groupId>org.openjdk.jol</groupId>
//   <artifactId>jol-core</artifactId>
//   <version>0.17</version>
// </dependency>

import org.openjdk.jol.info.ClassLayout;

class Point {
    int x;
    int y;
}

public class ObjectLayoutDemo {
    public static void main(String[] args) {
        Point p = new Point();
        System.out.println(ClassLayout.parseInstance(p).toPrintable());
    }
}
```

```bash
# ì¶œë ¥:
# Point object internals:
# OFFSET  SIZE   TYPE DESCRIPTION                    VALUE
#      0     4        (object header)                01 00 00 00
#      4     4        (object header)                00 00 00 00
#      8     4        (object header)                43 c0 00 f8
#     12     4    int Point.x                        0
#     16     4    int Point.y                        0
#     20     4        (loss due to alignment)
# Instance size: 24 bytes
# Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

---

### ì‹¤í—˜ 2: ë‹¤ì–‘í•œ íƒ€ì… í•„ë“œ ì •ë ¬ í™•ì¸

```java
class Mixed {
    byte b;      // 1
    long l;      // 8
    int i;       // 4
    short s;     // 2
}

System.out.println(ClassLayout.parseClass(Mixed.class).toPrintable());
```

```bash
# ì¶œë ¥:
# Mixed object internals:
# OFFSET  SIZE   TYPE    FIELD
#      0    12          (object header)
#     12     4   int    i        â† int (4ë°”ì´íŠ¸ ì •ë ¬)
#     16     2   short  s        â† short
#     18     1   byte   b        â† byte
#     19     1          (alignment/padding gap)
#     20     8   long   l        â† long (8ë°”ì´íŠ¸ ì •ë ¬ í•„ìš”)
#     28     4          (loss due to alignment)
# Instance size: 32 bytes

# í•„ë“œ ìˆœì„œì™€ ë‹¤ë¥´ê²Œ ì¬ë°°ì¹˜ë¨ (ìµœì  ì •ë ¬)
```

---

### ì‹¤í—˜ 3: ë¹ˆ ê°ì²´ í¬ê¸°

```java
class Empty { }

System.out.println(ClassLayout.parseClass(Empty.class).toPrintable());
```

```bash
# ì¶œë ¥:
# Empty object internals:
# OFFSET  SIZE   TYPE
#      0     4        (object header)  Mark Word ì• 4ë°”ì´íŠ¸
#      4     4        (object header)  Mark Word ë’¤ 4ë°”ì´íŠ¸
#      8     4        (object header)  Class Pointer
#     12     4        (loss due to alignment)
# Instance size: 16 bytes

# í•„ë“œ ì—†ì–´ë„ 16ë°”ì´íŠ¸ (Object Header 12 + Padding 4)
```

---

### ì‹¤í—˜ 4: ë°°ì—´ ë ˆì´ì•„ì›ƒ

```java
int[] arr = new int[3];
System.out.println(ClassLayout.parseInstance(arr).toPrintable());
```

```bash
# ì¶œë ¥:
# [I object internals:
# OFFSET  SIZE   TYPE
#      0     4        (object header)  Mark Word
#      4     4        (object header)
#      8     4        (object header)  Class Pointer
#     12     4        (object header)  Array Length = 3
#     16     4    int [I.<elements>      arr[0]
#     20     4    int [I.<elements>      arr[1]
#     24     4    int [I.<elements>      arr[2]
#     28     4        (loss due to alignment)
# Instance size: 32 bytes

# ë°°ì—´ì€ Array Length í•„ë“œ ì¶”ê°€ (4ë°”ì´íŠ¸)
```

---

## âš¡ ì‹¤ë¬´ ì„íŒ©íŠ¸

### ë©”ëª¨ë¦¬ ìµœì í™” â€” í•„ë“œ ìˆœì„œ ì¬ë°°ì¹˜

```java
// âŒ ë¹„íš¨ìœ¨ì  ìˆœì„œ
class BadLayout {
    byte b1;     // 1
    long l1;     // 8 (7ë°”ì´íŠ¸ íŒ¨ë”© í•„ìš”)
    byte b2;     // 1
    long l2;     // 8 (7ë°”ì´íŠ¸ íŒ¨ë”© í•„ìš”)
    byte b3;     // 1
}
// í¬ê¸°: 12(header) + 1 + 7(padding) + 8 + 1 + 7(padding) + 8 + 1 + 7(padding) = 52 bytes

// âœ… ìµœì í™”ëœ ìˆœì„œ
class GoodLayout {
    long l1;     // 8
    long l2;     // 8
    byte b1;     // 1
    byte b2;     // 1
    byte b3;     // 1
}
// í¬ê¸°: 12(header) + 8 + 8 + 1 + 1 + 1 + 1(padding) = 32 bytes
// â†’ 20ë°”ì´íŠ¸ ì ˆì•½ (38% ê°ì†Œ)
```

### ëŒ€ëŸ‰ ê°ì²´ ì‹œìŠ¤í…œì˜ ë©”ëª¨ë¦¬ ì ˆì•½

```
ì‹œë‚˜ë¦¬ì˜¤:
  100ë§Œ ê°œ Point ê°ì²´
  
  BadLayout (52 bytes) Ã— 1,000,000 = 52 MB
  GoodLayout (32 bytes) Ã— 1,000,000 = 32 MB
  â†’ 20 MB ì ˆì•½

ìºì‹œ ì§€ì—­ì„± í–¥ìƒ:
  ì‘ì€ ê°ì²´ â†’ CPU ìºì‹œì— ë” ë§ì´ ì ì¬
  â†’ ìºì‹œ íˆíŠ¸ìœ¨ ì¦ê°€ â†’ ì„±ëŠ¥ í–¥ìƒ
```

### Boolean vs BitSet

```java
// âŒ Boolean ë°°ì—´
boolean[] flags = new boolean[1000];
// í¬ê¸°: 16(í—¤ë”) + 4(length) + 1000(ìš”ì†Œ) + 4(padding) = 1024 bytes

// âœ… BitSet
BitSet bits = new BitSet(1000);
// í¬ê¸°: ~200 bytes (ë‚´ë¶€ì ìœ¼ë¡œ long[] ì‚¬ìš©)
// â†’ 5ë°° ì ˆì•½

// ëŒ€ëŸ‰ í”Œë˜ê·¸ ì €ì¥ ì‹œ BitSet ê¶Œì¥
```

### Compressed Oops ê²½ê³„ â€” 32GB

```bash
# í™ < 32GB: Compressed Oops í™œì„±í™”
java -Xmx16g -XX:+PrintCommandLineFlags MyApp
# -XX:+UseCompressedOops (ê¸°ë³¸)

# í™ > 32GB: ìë™ ë¹„í™œì„±í™”
java -Xmx48g -XX:+PrintCommandLineFlags MyApp
# -XX:-UseCompressedOops (ìë™)

ì˜í–¥:
  Compressed Oops ë¹„í™œì„±í™” ì‹œ:
  - Object Header: 12 â†’ 16 bytes
  - Reference í•„ë“œ: 4 â†’ 8 bytes
  - ì „ì²´ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ~30% ì¦ê°€

ê¶Œì¥:
  í™ í¬ê¸°ë¥¼ 32GB ë¯¸ë§Œìœ¼ë¡œ ìœ ì§€
  32GB ì´ìƒ í•„ìš”í•˜ë©´ ì—¬ëŸ¬ JVM ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¶„ì‚°
```

---

## ğŸš« í”í•œ ì˜¤í•´

### "í•„ë“œ ì„ ì–¸ ìˆœì„œëŒ€ë¡œ ë©”ëª¨ë¦¬ì— ë°°ì¹˜ëœë‹¤"

```java
âŒ ì˜ëª»ëœ ì´í•´:
  ì½”ë“œì—ì„œ ì„ ì–¸í•œ ìˆœì„œëŒ€ë¡œ ë©”ëª¨ë¦¬ì— ì €ì¥ëœë‹¤.

âœ… ì‹¤ì œ:
  JVMì´ íƒ€ì…ë³„ë¡œ ì¬ì •ë ¬
  í° íƒ€ì…(long, double)ë¶€í„° ë°°ì¹˜
  
  ì´ìœ :
  - ë©”ëª¨ë¦¬ ì •ë ¬ ìµœì í™”
  - íŒ¨ë”© ìµœì†Œí™”
  - CPU ì ‘ê·¼ íš¨ìœ¨

ì˜ˆì™¸:
  @Contended ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ìºì‹œë¼ì¸ ë¶„ë¦¬ ì‹œ
  ìˆœì„œ ë³´ì¥ ê°€ëŠ¥ (False Sharing ë°©ì§€)
```

### "ë¹ˆ ê°ì²´ëŠ” ë©”ëª¨ë¦¬ë¥¼ ì°¨ì§€í•˜ì§€ ì•ŠëŠ”ë‹¤"

```
âŒ ì˜ëª»ëœ ì´í•´:
  new Object()ëŠ” í•„ë“œê°€ ì—†ìœ¼ë‹ˆ ë©”ëª¨ë¦¬ë¥¼ ì•ˆ ì“´ë‹¤.

âœ… ì‹¤ì œ:
  ë¹ˆ ê°ì²´ë„ ìµœì†Œ 16ë°”ì´íŠ¸
  - Object Header: 12 bytes
  - Padding: 4 bytes (8ë°”ì´íŠ¸ ì •ë ¬)
  
  Lock, Sentinel, Placeholder íŒ¨í„´ì—ì„œ ì£¼ì˜
  
  Object[] locks = new Object[1000];
  for (int i = 0; i < 1000; i++) {
      locks[i] = new Object();  // ê° 16ë°”ì´íŠ¸
  }
  // â†’ 16KB ë©”ëª¨ë¦¬ ì†Œë¹„
```

### "ë°°ì—´ì€ ìš”ì†Œë§Œ ì €ì¥í•œë‹¤"

```
âŒ ì˜ëª»ëœ ì´í•´:
  int[10]ì€ 40ë°”ì´íŠ¸ (int 10ê°œ Ã— 4ë°”ì´íŠ¸)

âœ… ì‹¤ì œ:
  int[10] í¬ê¸°:
  - Object Header: 12 bytes
  - Array Length: 4 bytes
  - Elements: 40 bytes (int 10ê°œ)
  - Padding: 0 bytes (ì´ë¯¸ 8ì˜ ë°°ìˆ˜)
  â†’ ì´ 56 bytes
  
  ë¹ˆ ë°°ì—´ë„ 16ë°”ì´íŠ¸:
  int[] empty = new int[0];
  // 12(í—¤ë”) + 4(length=0) = 16 bytes
```

---

## ğŸ“Œ í•µì‹¬ ì •ë¦¬

```
ê°ì²´ ë©”ëª¨ë¦¬ êµ¬ì¡°
  Object Header (12 bytes, ì••ì¶• í™œì„±í™” ì‹œ)
  - Mark Word (8 bytes): Hash, Age, Lock ìƒíƒœ
  - Class Pointer (4 bytes): í´ë˜ìŠ¤ ë©”íƒ€ë°ì´í„° ì£¼ì†Œ
  
  Instance Data: ì‹¤ì œ í•„ë“œ ê°’
  Padding: 8ë°”ì´íŠ¸ ì •ë ¬

ë°°ì—´ ì¶”ê°€ í•„ë“œ
  Array Length (4 bytes)
  â†’ ë°°ì—´ í—¤ë”ëŠ” 16 bytes

í•„ë“œ ì •ë ¬ ìˆœì„œ
  long/double â†’ int/float â†’ short/char â†’ byte/boolean â†’ reference
  ë¶€ëª¨ í•„ë“œ ë¨¼ì €, ìì‹ í•„ë“œ ë‚˜ì¤‘

Mark Word ì—­í• 
  Hash code (31ë¹„íŠ¸)
  GC age (4ë¹„íŠ¸, 0~15)
  Lock ìƒíƒœ (2ë¹„íŠ¸)
  Biased lock thread ID (54ë¹„íŠ¸)

Compressed Oops
  í™ < 32GB: 4ë°”ì´íŠ¸ í¬ì¸í„° (í™œì„±í™”)
  í™ > 32GB: 8ë°”ì´íŠ¸ í¬ì¸í„° (ìë™ ë¹„í™œì„±í™”)
  â†’ ë©”ëª¨ë¦¬ 30% ì¦ê°€

ìµœì í™” ì „ëµ
  í° íƒ€ì…ì„ ì•ì— ì„ ì–¸ (long/double ë¨¼ì €)
  Boolean ë°°ì—´ ëŒ€ì‹  BitSet
  32GB í™ ê²½ê³„ ê³ ë ¤

JOL ë„êµ¬
  ClassLayout.parseInstance(obj).toPrintable()
  ì‹¤ì œ ë©”ëª¨ë¦¬ ë ˆì´ì•„ì›ƒ í™•ì¸
```

---

## ğŸ¤” ìƒê°í•´ë³¼ ë¬¸ì œ

**Q1.** ë‹¤ìŒ í´ë˜ìŠ¤ì˜ ì‹¤ì œ ë©”ëª¨ë¦¬ í¬ê¸°ë¥¼ ê³„ì‚°í•˜ë¼. Object Header, í•„ë“œ ì •ë ¬, Paddingì„ ëª¨ë‘ ê³ ë ¤í•˜ë¼.

```java
class Data {
    byte b;
    long l;
    int i;
    boolean flag;
}
```

**Q2.** 100ë§Œ ê°œì˜ `Point(int x, int y)` ê°ì²´ë¥¼ ì €ì¥í•´ì•¼ í•œë‹¤. ê°œë³„ ê°ì²´ vs `int[] x`, `int[] y` ë‘ ë°°ì—´ë¡œ ë¶„ë¦¬í•˜ëŠ” ë°©ì‹ì˜ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ë¹„êµí•˜ê³ , ê°ê°ì˜ ì¥ë‹¨ì ì„ ì„¤ëª…í•˜ë¼.

**Q3.** í™ í¬ê¸°ë¥¼ 30GBë¡œ ì„¤ì •í–ˆì„ ë•Œì™€ 36GBë¡œ ì„¤ì •í–ˆì„ ë•Œ Compressed Oops í™œì„±í™” ì—¬ë¶€ì™€ ì „ì²´ ë©”ëª¨ë¦¬ íš¨ìœ¨ì„ ë¹„êµí•˜ë¼. ê°ì²´ 100ë§Œ ê°œ, ê° ê°ì²´ì— reference í•„ë“œ 5ê°œê°€ ìˆë‹¤ê³  ê°€ì •í•˜ë¼.

> ğŸ’¡ **í•´ì„¤**
>
> **Q1.** Object Header: 12 bytes. í•„ë“œ ì •ë ¬: long (8) â†’ int (4) â†’ byte (1) â†’ boolean (1). ë ˆì´ì•„ì›ƒ: 0~12 í—¤ë”, 12~20 long l (8ë°”ì´íŠ¸ ì •ë ¬), 20~24 int i, 24~25 byte b, 25~26 boolean flag, 26~32 padding (8ì˜ ë°°ìˆ˜ ì •ë ¬). ì´ 32 bytes.
>
> **Q2.** ê°œë³„ ê°ì²´: `Point` 1ê°œ = 12(í—¤ë”) + 4(x) + 4(y) + 4(padding) = 24 bytes. 100ë§Œ ê°œ = 24MB. ë°°ì—´ ë¶„ë¦¬: `int[] x` = 16(í—¤ë”) + 4,000,000(ìš”ì†Œ) = ~4MB, `int[] y` = ~4MB, ì´ 8MB. **ì¥ì (ë°°ì—´)**: ë©”ëª¨ë¦¬ 3ë°° ì ˆì•½, ìºì‹œ ì§€ì—­ì„± í–¥ìƒ (xë§Œ ìˆœíšŒ ì‹œ y ìºì‹œ ì•ˆ ë¡œë“œ). **ë‹¨ì (ë°°ì—´)**: ì¸ë±ìŠ¤ ê´€ë¦¬ ë³µì¡, OOP ìœ„ë°°. ì„±ëŠ¥ì´ ì¤‘ìš”í•˜ê³  ë°ì´í„°ê°€ ëŒ€ëŸ‰ì´ë©´ ë°°ì—´, ìœ ì§€ë³´ìˆ˜ì„± ì¤‘ìš”í•˜ë©´ ê°ì²´.
>
> **Q3.** 30GB: Compressed Oops í™œì„±í™”. Object Header 12 bytes, reference í•„ë“œ 4 bytes Ã— 5 = 20 bytes. ê°ì²´ë‹¹ ~32 bytes (íŒ¨ë”© í¬í•¨). 100ë§Œ ê°œ = 32MB. 36GB: Compressed Oops ë¹„í™œì„±í™”. Object Header 16 bytes, reference í•„ë“œ 8 bytes Ã— 5 = 40 bytes. ê°ì²´ë‹¹ ~56 bytes. 100ë§Œ ê°œ = 56MB. â†’ 75% ì¦ê°€. ê¶Œì¥: í™ì„ 30GBë¡œ ìœ ì§€í•˜ê±°ë‚˜, 32GB ì´ìƒ í•„ìš”í•˜ë©´ JVM 2ê°œë¡œ ë¶„ì‚° (ê° 18GB Ã— 2 = 36GB, Compressed Oops ìœ ì§€).

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [OpenJDK JOL (Java Object Layout)](https://github.com/openjdk/jol)
- [HotSpot Object Header Implementation](https://github.com/openjdk/jdk/blob/master/src/hotspot/share/oops/oop.hpp)
- [Aleksey ShipilÑ‘v â€” Java Objects Inside Out](https://shipilev.net/jvm/objects-inside-out/)

---

<div align="center">

**[â¬…ï¸ ì´ì „: Runtime Constant Pool](./05-runtime-constant-pool.md)** | **[ë‹¤ìŒ: Off-Heap & Direct Memory â¡ï¸](./07-off-heap-direct-memory.md)**

</div>
