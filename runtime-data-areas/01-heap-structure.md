# Heap Structure - í™ êµ¬ì¡°

---

## ğŸ¯ í•µì‹¬ ì§ˆë¬¸

ì´ ë¬¸ì„œë¥¼ ì½ê³  ë‚˜ë©´ ë‹¤ìŒ ì§ˆë¬¸ì— ë‹µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- `new` í‚¤ì›Œë“œë¡œ ìƒì„±í•œ ê°ì²´ëŠ” í™ì˜ ì •í™•íˆ ì–´ëŠ ì˜ì—­ì— í• ë‹¹ë˜ëŠ”ê°€?
- Edenì—ì„œ Survivorë¡œ, Survivorì—ì„œ Oldë¡œ ê°ì²´ê°€ ì´ë™í•˜ëŠ” ì •í™•í•œ ì¡°ê±´ì€?
- Young GCì™€ Full GCëŠ” ë¬´ì—‡ì´ ë‹¤ë¥´ë©°, ì™œ Young GCê°€ í›¨ì”¬ ë¹ ë¥¸ê°€?
- `-Xms`ì™€ `-Xmx`ëŠ” í™ì˜ ì–´ë–¤ ë¶€ë¶„ í¬ê¸°ë¥¼ ì„¤ì •í•˜ëŠ”ê°€?
- G1 GCì—ì„œëŠ” í™ êµ¬ì¡°ê°€ ì–´ë–»ê²Œ ë‹¬ë¼ì§€ëŠ”ê°€?

---

## ğŸ” ì™œ ì´ê²Œ ì¡´ì¬í•˜ëŠ”ê°€

### ë¬¸ì œ: ëª¨ë“  ê°ì²´ë¥¼ í•˜ë‚˜ì˜ ê³µê°„ì— ë‘ë©´ GCê°€ ëŠë¦¬ë‹¤

```
ë‹¨ìˆœí•œ ì„¤ê³„:
  í™ = í•˜ë‚˜ì˜ ê±°ëŒ€í•œ ë©”ëª¨ë¦¬ ê³µê°„
  ëª¨ë“  ê°ì²´ê°€ ê°™ì€ ê³³ì— ì¡´ì¬
  
  GC ì‹œ:
  - ì „ì²´ í™ì„ ìŠ¤ìº”í•´ì•¼ í•¨
  - ì‚´ì•„ìˆëŠ” ê°ì²´ì™€ ì£½ì€ ê°ì²´ê°€ ë’¤ì„ì„
  - ë©”ëª¨ë¦¬ ì •ë¦¬ ì‹œê°„ì´ í™ í¬ê¸°ì— ë¹„ë¡€

  4GB í™ì´ë©´?
  - ëª¨ë“  GCê°€ 4GB ì „ì²´ë¥¼ ìŠ¤ìº”
  - ìˆ˜ ì´ˆ ~ ìˆ˜ì‹­ ì´ˆ Stop-The-World
  - ì‹¤ìš© ë¶ˆê°€ëŠ¥
```

JVMì€ ì´ ë¬¸ì œë¥¼ "ê°ì²´ì˜ ìˆ˜ëª…"ì´ë¼ëŠ” ê´€ì°°ì—ì„œ í•´ê²°ì±…ì„ ì°¾ì•˜ë‹¤.

```
Weak Generational Hypothesis (ì•½í•œ ì„¸ëŒ€ë³„ ê°€ì„¤):
  "ëŒ€ë¶€ë¶„ì˜ ê°ì²´ëŠ” ì Šì–´ì„œ ì£½ëŠ”ë‹¤"
  
  ì‹¤ì¸¡ ë°ì´í„°:
  - ìƒì„±ëœ ê°ì²´ì˜ 90% ì´ìƒì´ ì²« GCì—ì„œ ì œê±°ë¨
  - ì¼ì‹œì  ì„ì‹œ ë³€ìˆ˜, ë£¨í”„ ë‚´ë¶€ ê°ì²´ ë“±
  
  ì„¤ê³„ ì›ì¹™:
  â†’ ì Šì€ ê°ì²´ì™€ ì˜¤ë˜ëœ ê°ì²´ë¥¼ ë¶„ë¦¬
  â†’ ì Šì€ ì˜ì—­ë§Œ ìì£¼ ì •ë¦¬
  â†’ ì „ì²´ ì •ë¦¬ëŠ” ê°€ë”ë§Œ
```

---

## ğŸ“ ë‚´ë¶€ êµ¬ì¡°

### 1. Generational Heap êµ¬ì¡° (Serial, Parallel, CMS ê¸°ì¤€)

```
ì „ì²´ í™ êµ¬ì¡°:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Heap                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Young Generation       â”‚      Old Generation          â”‚
â”‚         (Young Gen)         â”‚         (Tenured)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
â”‚ Eden â”‚ Survivor â”‚ Survivor  â”‚                              â”‚
â”‚      â”‚    0     â”‚     1     â”‚                              â”‚
â”‚ (80%)â”‚  (10%)   â”‚   (10%)   â”‚        (Full GC ëŒ€ìƒ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘                                    â†‘
Young GC (Minor GC) ëŒ€ìƒ         Full GC (Major GC) ëŒ€ìƒ

ë¹„ìœ¨ (ê¸°ë³¸):
  Young : Old = 1 : 2
  Eden : Survivor = 8 : 1 : 1
```

---

### 2. ê°ì²´ í• ë‹¹ê³¼ ì´ë™ â€” ìƒëª…ì£¼ê¸°

```
ê°ì²´ ìƒëª…ì£¼ê¸°:

1. íƒ„ìƒ (Eden)
   new MyObject() â†’ Eden ì˜ì—­ì— í• ë‹¹
   
2. ì²« ë²ˆì§¸ GC (Eden â†’ Survivor 0)
   Young GC ë°œìƒ
   ì‚´ì•„ë‚¨ì€ ê°ì²´ â†’ Survivor 0ìœ¼ë¡œ ë³µì‚¬
   Eden ì „ì²´ í´ë¦¬ì–´
   
3. ë‘ ë²ˆì§¸ GC (Survivor 0 â†’ Survivor 1)
   Young GC ë°œìƒ
   Edenì˜ ì‹ ê·œ ê°ì²´ + Survivor 0ì˜ ê¸°ì¡´ ê°ì²´
   â†’ ì‚´ì•„ë‚¨ì€ ê²ƒë“¤ë§Œ Survivor 1ë¡œ ë³µì‚¬
   Eden + Survivor 0 í´ë¦¬ì–´
   
4. Age ì¦ê°€
   ë§¤ Young GC ë•Œë§ˆë‹¤ Age + 1
   (Object Headerì˜ Age í•„ë“œ, ìµœëŒ€ 15)
   
5. Promotion (Old Generationìœ¼ë¡œ ìŠ¹ê²©)
   Age >= -XX:MaxTenuringThreshold (ê¸°ë³¸ 15)
   ë˜ëŠ” Survivor ê³µê°„ ë¶€ì¡± ì‹œ
   â†’ Old Generationìœ¼ë¡œ ì´ë™

6. Full GC
   Old Generationì´ ê±°ì˜ ì°¼ì„ ë•Œ
   ì „ì²´ í™(Young + Old) ëŒ€ìƒ GC ì‹¤í–‰
```

#### ì‹¤ì œ íë¦„ ì‹œë®¬ë ˆì´ì…˜

```
ì‹œê°„ T0:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Eden     â”‚ S0       â”‚ S1       â”‚ Old         â”‚
â”‚ [A][B]   â”‚ []       â”‚ []       â”‚ []          â”‚
â”‚ [C][D]   â”‚          â”‚          â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T1: Young GC #1 (A, Bë§Œ ì‚´ì•„ë‚¨ìŒ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Eden     â”‚ S0       â”‚ S1       â”‚ Old         â”‚
â”‚ []       â”‚ [AÂ¹][BÂ¹] â”‚ []       â”‚ []          â”‚
â”‚          â”‚          â”‚          â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†‘ Age 1

T2: ìƒˆ ê°ì²´ E, F ìƒì„± í›„ Young GC #2 (A, Eë§Œ ì‚´ì•„ë‚¨ìŒ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Eden     â”‚ S0       â”‚ S1       â”‚ Old         â”‚
â”‚ []       â”‚ []       â”‚ [AÂ²][EÂ¹] â”‚ []          â”‚
â”‚          â”‚          â”‚          â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†‘ Age 2  â†‘ Age 1

T3: ìƒˆ ê°ì²´ G ìƒì„±, Young GC #3, Aì˜ Ageê°€ ì„ê³„ê°’ ë„ë‹¬
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Eden     â”‚ S0       â”‚ S1       â”‚ Old         â”‚
â”‚ []       â”‚ [EÂ²][GÂ¹] â”‚ []       â”‚ [A]         â”‚
â”‚          â”‚          â”‚          â”‚   â†‘         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  Promoted!
```

---

### 3. Young GC vs Full GC

```
Young GC (Minor GC):
  ëŒ€ìƒ: Young Generation (Eden + Survivor)
  ë¹ˆë„: ë§¤ìš° ë¹ˆë²ˆ (ì´ˆ ë‹¨ìœ„)
  ì†Œìš” ì‹œê°„: ìˆ˜ ë°€ë¦¬ì´ˆ ~ ìˆ˜ì‹­ ë°€ë¦¬ì´ˆ
  ì•Œê³ ë¦¬ì¦˜: Copy (ì‚´ì•„ìˆëŠ” ê°ì²´ë§Œ ë³µì‚¬)
  Stop-The-World: ë§¤ìš° ì§§ìŒ
  
  íŠ¸ë¦¬ê±° ì¡°ê±´:
  - Edenì´ ê°€ë“ ì°¼ì„ ë•Œ

Full GC (Major GC):
  ëŒ€ìƒ: ì „ì²´ í™ (Young + Old)
  ë¹ˆë„: ë“œë¬¼ê²Œ (ë¶„ ë‹¨ìœ„ ì´ìƒ)
  ì†Œìš” ì‹œê°„: ìˆ˜ë°± ë°€ë¦¬ì´ˆ ~ ìˆ˜ ì´ˆ
  ì•Œê³ ë¦¬ì¦˜: Mark-Sweep-Compact (ì „ì²´ ì •ë¦¬)
  Stop-The-World: ê¸´ í¸
  
  íŠ¸ë¦¬ê±° ì¡°ê±´:
  - Old Generationì´ ê±°ì˜ ì°¼ì„ ë•Œ
  - System.gc() í˜¸ì¶œ (ê¶Œì¥ ì•ˆ í•¨)
  - Metaspace ë¶€ì¡±
  - Promotion ì‹¤íŒ¨ (Survivor â†’ Old ì´ë™ ì‹¤íŒ¨)
```

---

### 4. í™ í¬ê¸° ì„¤ì • í”Œë˜ê·¸

```
-Xms<size>: ì´ˆê¸° í™ í¬ê¸° (Minimum)
  ì˜ˆ: -Xms2g â†’ JVM ì‹œì‘ ì‹œ 2GB í• ë‹¹
  
-Xmx<size>: ìµœëŒ€ í™ í¬ê¸° (Maximum)
  ì˜ˆ: -Xmx4g â†’ ìµœëŒ€ 4GBê¹Œì§€ í™•ì¥ ê°€ëŠ¥
  
ê¶Œì¥:
  -Xms == -Xmx (ê°™ì€ ê°’)
  â†’ í™ í¬ê¸° ë³€ë™ ì—†ìŒ â†’ ì„±ëŠ¥ ì•ˆì •
  
-XX:NewRatio=<n>: Young : Old ë¹„ìœ¨
  ì˜ˆ: -XX:NewRatio=2 â†’ Young : Old = 1 : 2
  
-XX:SurvivorRatio=<n>: Eden : Survivor ë¹„ìœ¨
  ì˜ˆ: -XX:SurvivorRatio=8 â†’ Eden : S0 : S1 = 8 : 1 : 1

-XX:MaxTenuringThreshold=<n>: Oldë¡œ ìŠ¹ê²©ë˜ëŠ” Age
  ì˜ˆ: -XX:MaxTenuringThreshold=15 (ê¸°ë³¸ê°’)
  ìµœì†Œ 1, ìµœëŒ€ 15
```

---

### 5. G1 GCì˜ Region ê¸°ë°˜ í™ êµ¬ì¡°

G1 GC (Java 9+ ê¸°ë³¸ GC)ëŠ” í™ì„ ë‹¤ë¥´ê²Œ ë‚˜ëˆˆë‹¤.

```
ì „í†µì  í™ (Serial, Parallel):
  Young | Old ë¡œ ë¬¼ë¦¬ì  ë¶„ë¦¬

G1 í™:
  ì „ì²´ í™ì„ ë™ì¼ í¬ê¸°ì˜ Regionìœ¼ë¡œ ë‚˜ëˆ”
  ê° Regionì´ Eden, Survivor, Old ì—­í• ì„ ë™ì ìœ¼ë¡œ ìˆ˜í–‰
  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [E] [E] [S] [O] [E] [H] [O] [E] [S] [O] [E] ...  â”‚
â”‚                                                   â”‚
â”‚  E = Eden Region                                  â”‚
â”‚  S = Survivor Region                              â”‚
â”‚  O = Old Region                                   â”‚
â”‚  H = Humongous Region (í° ê°ì²´ ì „ìš©)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Region í¬ê¸°:
  -XX:G1HeapRegionSize=<n>
  1MB ~ 32MB (2ì˜ ê±°ë“­ì œê³±)
  ê¸°ë³¸: í™ í¬ê¸°ì— ë”°ë¼ ìë™ ê³„ì‚° (ì•½ 2048ê°œ Region)

ì¥ì :
  - Region ë‹¨ìœ„ë¡œ GC â†’ ì „ì²´ í™ì„ í•œ ë²ˆì— ì •ë¦¬í•  í•„ìš” ì—†ìŒ
  - Pause Time Goal ì„¤ì • ê°€ëŠ¥ (-XX:MaxGCPauseMillis)
  - Fragmentation ìµœì†Œí™”
```

---

## ğŸ’» ì‹¤í—˜ìœ¼ë¡œ í™•ì¸í•˜ê¸°

### ì‹¤í—˜ 1: í™ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

```java
public class HeapMonitor {
    public static void main(String[] args) throws InterruptedException {
        Runtime runtime = Runtime.getRuntime();
        
        System.out.println("=== Heap ì´ˆê¸° ìƒíƒœ ===");
        printMemory(runtime);
        
        // ëŒ€ëŸ‰ ê°ì²´ ìƒì„± (Eden ì±„ìš°ê¸°)
        System.out.println("\n=== ê°ì²´ 10ë§Œ ê°œ ìƒì„± ===");
        Object[] array = new Object[100_000];
        for (int i = 0; i < 100_000; i++) {
            array[i] = new byte[1024]; // 1KBì”©
        }
        printMemory(runtime);
        
        // ê°•ì œ GC
        System.out.println("\n=== System.gc() í˜¸ì¶œ ===");
        System.gc();
        Thread.sleep(100);
        printMemory(runtime);
        
        // ì°¸ì¡° í•´ì œ
        System.out.println("\n=== ì°¸ì¡° í•´ì œ í›„ GC ===");
        array = null;
        System.gc();
        Thread.sleep(100);
        printMemory(runtime);
    }
    
    static void printMemory(Runtime runtime) {
        long total = runtime.totalMemory();
        long free = runtime.freeMemory();
        long used = total - free;
        long max = runtime.maxMemory();
        
        System.out.printf("Total: %d MB, Used: %d MB, Free: %d MB, Max: %d MB%n",
            total / 1024 / 1024, used / 1024 / 1024, free / 1024 / 1024, max / 1024 / 1024);
    }
}
```

```bash
# GC ë¡œê·¸ì™€ í•¨ê»˜ ì‹¤í–‰
java -Xms512m -Xmx512m -Xlog:gc*::time HeapMonitor
```

---

### ì‹¤í—˜ 2: ê°ì²´ Ageì™€ Promotion ê´€ì°°

```java
public class ObjectAgingDemo {
    static class Tracker {
        byte[] data = new byte[1024]; // 1KB
    }
    
    public static void main(String[] args) {
        // Young GCë¥¼ ì—¬ëŸ¬ ë²ˆ ìœ ë„í•´ Age ì¦ê°€ ê´€ì°°
        for (int i = 0; i < 20; i++) {
            System.out.println("\n=== Iteration " + i + " ===");
            
            // Edenì„ ë¹ ë¥´ê²Œ ì±„ìš°ê¸°
            for (int j = 0; j < 10000; j++) {
                new Tracker();
            }
            
            // ì ì‹œ ëŒ€ê¸° í›„ GC ë¡œê·¸ í™•ì¸
            try { Thread.sleep(100); } catch (InterruptedException e) {}
        }
    }
}
```

```bash
# Survivor í¬ê¸°ë¥¼ ì‘ê²Œ ì„¤ì •í•´ ë¹ ë¥¸ Promotion ìœ ë„
java -Xms256m -Xmx256m \
     -XX:NewRatio=2 \
     -XX:SurvivorRatio=8 \
     -XX:MaxTenuringThreshold=3 \
     -Xlog:gc*,age*=trace::time \
     ObjectAgingDemo

# ì¶œë ¥ì—ì„œ "Desired survivor size", "age" ë“± í™•ì¸
# age 1, age 2... ê°ì²´ë“¤ì´ ì¦ê°€í•˜ë‹¤ê°€ Oldë¡œ ì´ë™í•˜ëŠ” ê²ƒ ê´€ì°°
```

---

### ì‹¤í—˜ 3: jstatìœ¼ë¡œ í™ ì‚¬ìš©ëŸ‰ ì‹¤ì‹œê°„ ì¶”ì 

```bash
# 1ì´ˆë§ˆë‹¤ í™ ìƒíƒœ ì¶œë ¥
jstat -gc <pid> 1000

# ì¶œë ¥ ì»¬ëŸ¼ ì„¤ëª…:
# S0C, S1C: Survivor 0/1 Capacity (KB)
# S0U, S1U: Survivor 0/1 Used (KB)
# EC:       Eden Capacity (KB)
# EU:       Eden Used (KB)
# OC:       Old Capacity (KB)
# OU:       Old Used (KB)
# YGC:      Young GC íšŸìˆ˜
# YGCT:     Young GC ì´ ì†Œìš” ì‹œê°„ (ì´ˆ)
# FGC:      Full GC íšŸìˆ˜
# FGCT:     Full GC ì´ ì†Œìš” ì‹œê°„ (ì´ˆ)

# ì˜ˆì‹œ ì¶œë ¥:
#  S0C    S1C    S0U    S1U      EC       EU        OC         OU       YGC  YGCT  FGC  FGCT
# 10240  10240    0    8192   81920    65536    204800    102400      5  0.050   1  0.120
```

---

## âš¡ ì‹¤ë¬´ ì„íŒ©íŠ¸

### í™ í¬ê¸° ì„¤ì • ì „ëµ

```
ì• í”Œë¦¬ì¼€ì´ì…˜ íƒ€ì…ë³„ ê¶Œì¥:

ë‹¨ê¸° ìš”ì²­-ì‘ë‹µ ì„œë²„ (ì›¹ì•±):
  Young : Old = 1 : 1 ë˜ëŠ” 1 : 2
  â†’ Youngì„ í¬ê²Œ â†’ ëŒ€ë¶€ë¶„ì˜ ê°ì²´ê°€ Youngì—ì„œ ì²˜ë¦¬
  
ë°°ì¹˜ ì‘ì—…, ì¥ì‹œê°„ ì—°ì‚°:
  Young : Old = 1 : 3 ë˜ëŠ” 1 : 4
  â†’ Oldë¥¼ í¬ê²Œ â†’ ì¥ìˆ˜ ê°ì²´ê°€ ë§ìŒ
  
ë©”ëª¨ë¦¬ ìºì‹œ (Ehcache, Caffeine):
  Oldë¥¼ í¬ê²Œ â†’ ìºì‹œ ê°ì²´ê°€ ì¥ì‹œê°„ ìœ ì§€
```

### Full GC ë¹ˆë„ë¥¼ ì¤„ì´ëŠ” ì„¤ê³„

```
ì•ˆí‹°íŒ¨í„´:
  static ì»¬ë ‰ì…˜ì— ê°ì²´ë¥¼ ê³„ì† ì¶”ê°€
  â†’ Old Generation ì¦ê°€ â†’ Full GC ë¹ˆë²ˆ
  
  public class Cache {
      static Map<String, Data> cache = new HashMap<>();
      
      public void add(String key, Data data) {
          cache.put(key, data); // ì˜ì›íˆ ë‚¨ìŒ
      }
  }

ê°œì„ :
  í¬ê¸° ì œí•œì´ ìˆëŠ” ìºì‹œ ì‚¬ìš© (LRU)
  WeakReference ë˜ëŠ” SoftReference í™œìš©
  
  public class BetterCache {
      static Map<String, WeakReference<Data>> cache = new HashMap<>();
      
      public void add(String key, Data data) {
          cache.put(key, new WeakReference<>(data));
          // GC ì••ë°• ì‹œ ìë™ ì œê±°
      }
  }
```

### ì»¨í…Œì´ë„ˆ í™˜ê²½ í™ ì„¤ì •

```
Docker / Kubernetes í™˜ê²½:

ì¼ë°˜ì ì¸ ì‹¤ìˆ˜:
  ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬: 4GB
  JVM í™: -Xmx4g
  â†’ OOM Killer ë°œë™!
  
  ì´ìœ :
  JVM ì „ì²´ ë©”ëª¨ë¦¬ = í™ + Metaspace + Thread Stack + Native Memory
  í™ë§Œ 4GBë©´ ì‹¤ì œ ì‚¬ìš©ëŸ‰ì€ ~5GB ì´ˆê³¼
  
ê¶Œì¥:
  ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬: 4GB
  JVM í™: -Xmx3g (75%)
  â†’ ë‚˜ë¨¸ì§€ 1GBëŠ” Metaspace, Thread Stack, Native ë“±ì— í• ë‹¹
  
Java 11+:
  -XX:+UseContainerSupport (ê¸°ë³¸ í™œì„±í™”)
  â†’ ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì œí•œì„ JVMì´ ì¸ì‹
  â†’ ìë™ìœ¼ë¡œ ì ì ˆí•œ í™ í¬ê¸° ì„¤ì •
```

---

## ğŸš« í”í•œ ì˜¤í•´

### "Young GCëŠ” Stop-The-Worldê°€ ì—†ë‹¤"

```
âŒ ì˜ëª»ëœ ì´í•´:
  Young GCëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë¼ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë©ˆì¶”ì§€ ì•ŠëŠ”ë‹¤.

âœ… ì‹¤ì œ:
  Young GCë„ Stop-The-Worldê°€ ë°œìƒí•œë‹¤.
  ë‹¨, Full GCë³´ë‹¤ í›¨ì”¬ ì§§ì„ ë¿ (ìˆ˜ ë°€ë¦¬ì´ˆ vs ìˆ˜ë°± ë°€ë¦¬ì´ˆ)
  
  ì´ìœ :
  Young Gen í¬ê¸°ê°€ ì‘ìŒ + Copy ì•Œê³ ë¦¬ì¦˜ì´ ë¹ ë¦„
  â†’ STWëŠ” ìˆì§€ë§Œ ì²´ê°í•˜ê¸° ì–´ë ¤ìš¸ ì •ë„ë¡œ ì§§ìŒ
  
  Concurrent GC (CMS, G1, ZGC):
  Young GCëŠ” ì—¬ì „íˆ STW
  Old GCë¥¼ Concurrentí•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” ê²ƒ
```

### "í™ì„ í¬ê²Œ ì„¤ì •í•˜ë©´ ë¬´ì¡°ê±´ ì¢‹ë‹¤"

```
âŒ ì˜ëª»ëœ ì´í•´:
  -Xmxë¥¼ ìµœëŒ€í•œ í¬ê²Œ â†’ ë©”ëª¨ë¦¬ ì—¬ìœ  â†’ ì„±ëŠ¥ í–¥ìƒ

âœ… ì‹¤ì œ:
  í™ì´ ë„ˆë¬´ í¬ë©´:
  1. Full GC ì†Œìš” ì‹œê°„ ì¦ê°€
     8GB í™ì˜ Full GC: ~1ì´ˆ
     32GB í™ì˜ Full GC: ~5ì´ˆ ì´ìƒ
  
  2. GC ì•Œê³ ë¦¬ì¦˜ íš¨ìœ¨ ì €í•˜
     íŠ¹íˆ Serial, Parallel GCëŠ” í™ í¬ê¸°ì— ë¯¼ê°
  
  3. ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œ OOM Killer ìœ„í—˜
  
  ì ì • í¬ê¸°:
  ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹¤ì œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ + 30~50% ì—¬ìœ 
  ëª¨ë‹ˆí„°ë§ í›„ ì¡°ì • (jstat, JFRë¡œ ì¸¡ì •)
```

### "SurvivorëŠ” í•­ìƒ ë‘ ê°œê°€ í™œì„±í™”ëœë‹¤"

```
âŒ ì˜ëª»ëœ ì´í•´:
  Survivor 0ê³¼ Survivor 1ì´ ë™ì‹œì— ì‚¬ìš©ëœë‹¤.

âœ… ì‹¤ì œ:
  ë‘ Survivor ì¤‘ í•­ìƒ í•˜ë‚˜ëŠ” ë¹„ì–´ìˆë‹¤.
  
  Copy ì•Œê³ ë¦¬ì¦˜:
  Eden + Survivor(ì‚¬ìš© ì¤‘) â†’ Survivor(ë¹„ì–´ìˆëŠ” ê³³)ìœ¼ë¡œ ë³µì‚¬
  
  GC #1: Eden + S0 â†’ S1 (S0 ë¹„ì›€)
  GC #2: Eden + S1 â†’ S0 (S1 ë¹„ì›€)
  GC #3: Eden + S0 â†’ S1 (S0 ë¹„ì›€)
  
  í•­ìƒ í•œ ìª½ì€ ë¹„ì–´ìˆì–´ì•¼ ë³µì‚¬í•  ê³µê°„ì´ ìƒê¹€
  ì´ê²ƒì´ "8 : 1 : 1" ë¹„ìœ¨ì˜ ì˜ë¯¸
  â†’ ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥ Young = Eden + Survivor 1ê°œ = 90%
```

---

## ğŸ“Œ í•µì‹¬ ì •ë¦¬

```
í™ êµ¬ì¡° (ì „í†µì  GC)
  Young Generation (Eden + Survivor 0 + Survivor 1)
  Old Generation (Tenured)

ê°ì²´ ìƒëª…ì£¼ê¸°
  new â†’ Eden
  Young GC ìƒì¡´ â†’ Survivor (Age++)
  Age >= Threshold ë˜ëŠ” Survivor ë¶€ì¡± â†’ Old (Promotion)
  Old ê°€ë“ â†’ Full GC

Young GC vs Full GC
  Young: ìì£¼, ë¹ ë¦„ (ìˆ˜ ms), Eden + Survivor ëŒ€ìƒ
  Full:  ë“œë¬¼ê²Œ, ëŠë¦¼ (ìˆ˜ë°± ms ~ ì´ˆ), ì „ì²´ í™ ëŒ€ìƒ

í™ í¬ê¸° í”Œë˜ê·¸
  -Xms / -Xmx: ì´ˆê¸° / ìµœëŒ€ í™ (ê°™ì€ ê°’ ê¶Œì¥)
  -XX:NewRatio: Young : Old ë¹„ìœ¨ (ê¸°ë³¸ 1:2)
  -XX:SurvivorRatio: Eden : Survivor ë¹„ìœ¨ (ê¸°ë³¸ 8:1:1)

G1 GCì˜ ì°¨ì´
  Region ê¸°ë°˜ (Young/Old ê³ ì • ë¶„ë¦¬ ì—†ìŒ)
  ë™ì ìœ¼ë¡œ Eden/Survivor/Old ì—­í•  ë³€ê²½
  Pause Time Goal ì„¤ì • ê°€ëŠ¥

ì‹¤ë¬´ í•µì‹¬
  ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ì˜ 75% ì •ë„ë¥¼ í™ìœ¼ë¡œ ì„¤ì •
  -Xms == -Xmxë¡œ ê³ ì • (í¬ê¸° ë³€ë™ ë°©ì§€)
  jstat, JFRë¡œ ì‹¤ì œ ì‚¬ìš©ëŸ‰ ì¸¡ì • í›„ ì¡°ì •
```

---

## ğŸ¤” ìƒê°í•´ë³¼ ë¬¸ì œ

**Q1.** Edenì˜ í¬ê¸°ë¥¼ ëŠ˜ë¦¬ë©´ Young GC ë¹ˆë„ê°€ ì¤„ì–´ë“ ë‹¤. ê·¸ëŸ°ë° ì™œ Edenì„ ë¬´í•œì • í¬ê²Œ ì„¤ì •í•˜ì§€ ì•ŠëŠ”ê°€? íŠ¸ë ˆì´ë“œì˜¤í”„ë¥¼ ì„¤ëª…í•˜ë¼.

**Q2.** `-XX:SurvivorRatio=2`ë¡œ ì„¤ì •í•˜ë©´ Eden : Survivor = 2 : 1 : 1ì´ ëœë‹¤. ì´ ê²½ìš° Survivor ê³µê°„ì´ ë„“ì–´ì§€ëŠ”ë°, ì–´ë–¤ ìƒí™©ì—ì„œ ì´ ì„¤ì •ì´ ìœ ë¦¬í•˜ê³  ì–´ë–¤ ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆëŠ”ê°€?

**Q3.** ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ 4GB, JVM í™ `-Xmx4g`ë¡œ ì„¤ì •í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ OOM Killed ë‹¹í–ˆë‹¤. Heap Dumpë¥¼ í™•ì¸í•˜ë‹ˆ í™ ì‚¬ìš©ëŸ‰ì€ 2.8GBë°–ì— ì•ˆ ëë‹¤. ë¬´ì—‡ì´ ë¬¸ì œì¸ê°€?

> ğŸ’¡ **í•´ì„¤**
>
> **Q1.** Edenì„ ëŠ˜ë¦¬ë©´ Young GC ë¹ˆë„ëŠ” ì¤„ì§€ë§Œ í•œ ë²ˆì˜ Young GC ì†Œìš” ì‹œê°„ì´ ì¦ê°€í•œë‹¤. Edenì´ 8GBë¼ë©´ Young GCê°€ ìˆ˜ë°± ë°€ë¦¬ì´ˆê¹Œì§€ ëŠ˜ì–´ë‚  ìˆ˜ ìˆë‹¤ (Copy ì•Œê³ ë¦¬ì¦˜ì€ ì‚´ì•„ìˆëŠ” ê°ì²´ ìˆ˜ì— ë¹„ë¡€). ë˜í•œ Edenì´ í¬ë©´ Promotionì´ ëŠ¦ì–´ì ¸ Oldì— ë¶ˆí•„ìš”í•œ ê°ì²´ê°€ ìŒ“ì´ê³  Full GC ë¹ˆë„ê°€ ì¦ê°€í•  ìˆ˜ ìˆë‹¤. ì ì • í¬ê¸°ëŠ” "ëŒ€ë¶€ë¶„ì˜ ì„ì‹œ ê°ì²´ê°€ Young GCì—ì„œ ì œê±°ë˜ëŠ” ì •ë„"ë¡œ, ë³´í†µ ìˆ˜ë°± MB ~ ìˆ˜ GB.
>
> **Q2.** Survivorê°€ ë„“ìœ¼ë©´ Ageê°€ ë†’ì€ ê°ì²´ë“¤ì´ Survivorì— ì˜¤ë˜ ë¨¸ë¬¼ ìˆ˜ ìˆì–´ Promotionì´ ì¤„ì–´ë“ ë‹¤. ì¥ìˆ˜ ê°ì²´ê°€ ë§ì€ ê²½ìš° (ì„¸ì…˜ ê°ì²´, ìºì‹œ ë“±) Oldë¡œ ìŠ¹ê²© ì „ì— ì£½ì„ ê¸°íšŒë¥¼ ë” ì¤€ë‹¤. ë¬¸ì œëŠ” Edenì´ ìƒëŒ€ì ìœ¼ë¡œ ì‘ì•„ì ¸ Young GC ë¹ˆë„ê°€ ì¦ê°€í•˜ê³ , Survivor ê°„ Copy ë¹„ìš©ì´ ì»¤ì§„ë‹¤ëŠ” ê²ƒ. ê¸°ë³¸ 8:1:1ì´ ëŒ€ë¶€ë¶„ ìµœì ì´ë©°, íŠ¹ìˆ˜í•œ ê²½ìš°ì—ë§Œ ì¡°ì •.
>
> **Q3.** JVM ì „ì²´ ë©”ëª¨ë¦¬ = í™ + Metaspace + Thread Stack + Code Cache + Native Memory. í™ì´ 2.8GBì—¬ë„ Metaspaceì— 500MB, ê° ìŠ¤ë ˆë“œ ìŠ¤íƒ(1MB * ìˆ˜ë°± ìŠ¤ë ˆë“œ)ì— ìˆ˜ë°± MB, Native ë©”ëª¨ë¦¬(NIO DirectBuffer ë“±)ì— ìˆ˜ë°± MBê°€ ì‚¬ìš©ë˜ë©´ ì´ 4GB ì´ˆê³¼ë¡œ ì»¨í…Œì´ë„ˆ ì œí•œì„ ë„˜ì–´ OOM Killer ë°œë™. í•´ê²°: ì»¨í…Œì´ë„ˆ 4GBë©´ í™ì€ `-Xmx3g` ì •ë„ë¡œ ì„¤ì •í•´ ë‚˜ë¨¸ì§€ ì˜ì—­ì— 1GB ì—¬ìœ  í™•ë³´.

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [JVMS Â§2.5 â€” Run-Time Data Areas](https://docs.oracle.com/javase/specs/jvms/se21/html/jvms-2.html#jvms-2.5)
- [HotSpot Memory Management Whitepaper](https://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf)
- [G1 GC Tuning Guide](https://docs.oracle.com/en/java/javase/17/gctuning/garbage-first-g1-garbage-collector1.html)

---

<div align="center">

**[â¬…ï¸ ì´ì „: ClassLoader Isolation](../class-loading/07-classloader-isolation.md)** | **[ë‹¤ìŒ: TLAB (Thread-Local Allocation Buffer) â¡ï¸](./02-tlab-thread-local-allocation.md)**

</div>
