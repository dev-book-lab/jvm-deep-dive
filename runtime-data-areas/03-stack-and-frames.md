# Stack And Frames - ìŠ¤íƒê³¼ í”„ë ˆì„

---

## ğŸ¯ í•µì‹¬ ì§ˆë¬¸

ì´ ë¬¸ì„œë¥¼ ì½ê³  ë‚˜ë©´ ë‹¤ìŒ ì§ˆë¬¸ì— ë‹µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ë©”ì„œë“œ í˜¸ì¶œ ì‹œ JVMì€ ì–´ë–¤ ì •ë³´ë¥¼ ìŠ¤íƒì— ì €ì¥í•˜ëŠ”ê°€?
- Local Variable Arrayì™€ Operand Stackì€ ì–´ë–»ê²Œ ë‹¤ë¥´ë©°, ë°”ì´íŠ¸ì½”ë“œ ì‹¤í–‰ ì‹œ ì–´ë–»ê²Œ ìƒí˜¸ì‘ìš©í•˜ëŠ”ê°€?
- `StackOverflowError`ëŠ” ì •í™•íˆ ì–¸ì œ ë°œìƒí•˜ëŠ”ê°€? ìŠ¤íƒ í¬ê¸°ì™€ ì¬ê·€ ê¹Šì´ì˜ ê´€ê³„ëŠ”?
- ìŠ¤ë ˆë“œë§ˆë‹¤ ë…ë¦½ì ì¸ ìŠ¤íƒì„ ê°€ì§€ëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€?
- `-Xss` í”Œë˜ê·¸ëŠ” ë¬´ì—‡ì„ ì œì–´í•˜ë©°, ì–´ë–»ê²Œ ì„¤ì •í•´ì•¼ í•˜ëŠ”ê°€?

---

## ğŸ” ì™œ ì´ê²Œ ì¡´ì¬í•˜ëŠ”ê°€

### ë¬¸ì œ: ë©”ì„œë“œ í˜¸ì¶œì€ ì¤‘ì²©ë˜ê³ , ê° í˜¸ì¶œì˜ ìƒíƒœë¥¼ ê¸°ì–µí•´ì•¼ í•œë‹¤

```java
public class Calculator {
    int add(int a, int b) {
        return a + b;
    }
    
    int compute(int x) {
        int result = add(x, 10);  // add() í˜¸ì¶œ
        return result * 2;        // add()ê°€ ëë‚˜ê³  ì—¬ê¸°ë¡œ ë³µê·€
    }
    
    public static void main(String[] args) {
        Calculator c = new Calculator();
        c.compute(5);  // compute() í˜¸ì¶œ
    }
}
```

```
ì‹¤í–‰ íë¦„:
  main() ì‹œì‘
    â†’ compute(5) í˜¸ì¶œ
      â†’ add(5, 10) í˜¸ì¶œ
        â†’ 15 ë°˜í™˜
      â† add() ì¢…ë£Œ
      â†’ result = 15
      â†’ 15 * 2 = 30 ë°˜í™˜
    â† compute() ì¢…ë£Œ
  â† main() ì¢…ë£Œ

ê° ë©”ì„œë“œëŠ” ìì‹ ì˜ ìƒíƒœë¥¼ ìœ ì§€í•´ì•¼ í•¨:
  - ì§€ì—­ ë³€ìˆ˜ (a, b, result, x, c)
  - ë§¤ê°œë³€ìˆ˜ (x=5, a=5, b=10)
  - ë³µê·€ ì£¼ì†Œ (add()ê°€ ëë‚˜ë©´ compute()ì˜ ì–´ë””ë¡œ ëŒì•„ê°ˆì§€)
```

JVMì€ ì´ë¥¼ **ìŠ¤íƒ í”„ë ˆì„(Stack Frame)**ìœ¼ë¡œ ê´€ë¦¬í•œë‹¤.

---

## ğŸ“ ë‚´ë¶€ êµ¬ì¡°

### 1. ìŠ¤ë ˆë“œë³„ JVM ìŠ¤íƒ

```
JVM ë©”ëª¨ë¦¬ êµ¬ì¡° ì¤‘ ìŠ¤íƒ ë¶€ë¶„:

ìŠ¤ë ˆë“œ 1                    ìŠ¤ë ˆë“œ 2
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JVM Stack       â”‚       â”‚  JVM Stack       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Frame: add  â”‚ â”‚       â”‚  â”‚ Frame: run â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚       â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚Frame:computeâ”‚ â”‚       â”‚  â”‚Frame:doWorkâ”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚       â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Frame:main  â”‚ â”‚       â”‚  â”‚ Frame:main â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

íŠ¹ì§•:
  - ìŠ¤ë ˆë“œë‹¹ 1ê°œì˜ ìŠ¤íƒ (ë…ë¦½ì )
  - LIFO (Last In First Out)
  - ë©”ì„œë“œ í˜¸ì¶œ = Push Frame
  - ë©”ì„œë“œ ì¢…ë£Œ = Pop Frame
```

---

### 2. Stack Frame êµ¬ì¡°

```
í•˜ë‚˜ì˜ Stack Frame:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Stack Frame                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Local Variable Array (LVA)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  0   â”‚  1   â”‚  2   â”‚  3   â”‚  4   â”‚      â”‚
â”‚  â”‚ this â”‚ arg1 â”‚ arg2 â”‚ var1 â”‚ var2 â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Operand Stack                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  15  â”‚ â† top                            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤                                  â”‚
â”‚  â”‚  10  â”‚                                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤                                  â”‚
â”‚  â”‚   5  â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Frame Data                                â”‚
â”‚  - Constant Pool Reference                 â”‚
â”‚  - Return Address                          â”‚
â”‚  - Exception Handler Info                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Local Variable Array (LVA)

```
ì§€ì—­ ë³€ìˆ˜ ì €ì¥ì†Œ:

ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ:
  void foo(int a, int b) {
      int c = a + b;
  }
  
  LVA:
  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
  â”‚  0   â”‚  1   â”‚  2   â”‚  3   â”‚
  â”‚ this â”‚  a   â”‚  b   â”‚  c   â”‚
  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
  â†‘ ì¸ë±ìŠ¤ 0ì€ í•­ìƒ this

static ë©”ì„œë“œ:
  static void bar(int x, int y) {
      int z = x * y;
  }
  
  LVA:
  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
  â”‚  0   â”‚  1   â”‚  2   â”‚
  â”‚  x   â”‚  y   â”‚  z   â”‚
  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
  â†‘ this ì—†ìŒ, ì¸ë±ìŠ¤ 0ë¶€í„° ë§¤ê°œë³€ìˆ˜

long / double (64ë¹„íŠ¸):
  void baz(long l, int i) { }
  
  LVA:
  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
  â”‚  0   â”‚  1   â”‚  2   â”‚  3   â”‚
  â”‚ this â”‚  l   â”‚ (l)  â”‚  i   â”‚
  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
           â†‘ longì€ 2ìŠ¬ë¡¯ ì°¨ì§€
```

---

### 4. Operand Stack

```
ë°”ì´íŠ¸ì½”ë“œ ì‹¤í–‰ ì‹œ ì„ì‹œ ë°ì´í„° ì €ì¥:

Java ì½”ë“œ:
  int result = a + b;

ë°”ì´íŠ¸ì½”ë“œ:
  iload_1      // LVA[1](a)ì„ Operand Stackì— push
  iload_2      // LVA[2](b)ë¥¼ Operand Stackì— push
  iadd         // Stackì—ì„œ ë‘ ê°’ pop, ë”í•œ í›„ ê²°ê³¼ push
  istore_3     // Stackì—ì„œ popí•´ì„œ LVA[3](result)ì— ì €ì¥

Operand Stack ë³€í™”:
  ì´ˆê¸°: []
  iload_1: [a]
  iload_2: [a, b]
  iadd:    [a+b]
  istore_3: []

â†’ ê³„ì‚°ê¸°ì²˜ëŸ¼ ë™ì‘ (RPN, Reverse Polish Notation)
```

```
ë³µì¡í•œ ì˜ˆì‹œ:

Java:
  int x = (a + b) * (c - d);

ë°”ì´íŠ¸ì½”ë“œ:
  iload_1    // a
  iload_2    // b
  iadd       // a+b
  iload_3    // c
  iload 4    // d
  isub       // c-d
  imul       // (a+b) * (c-d)
  istore 5   // xì— ì €ì¥

Operand Stack:
  [] â†’ [a] â†’ [a,b] â†’ [a+b] â†’ [a+b,c] â†’ [a+b,c,d] 
  â†’ [a+b,c-d] â†’ [(a+b)*(c-d)] â†’ []
```

---

### 5. Frame Data

```
ë©”ì„œë“œ ì‹¤í–‰ì— í•„ìš”í•œ ë©”íƒ€ë°ì´í„°:

1. Constant Pool Reference
   í˜„ì¬ ë©”ì„œë“œê°€ ì†í•œ í´ë˜ìŠ¤ì˜ Runtime Constant Pool ì°¸ì¡°
   â†’ ì‹¬ë³¼ë¦­ ì°¸ì¡° í•´ê²° ì‹œ ì‚¬ìš©

2. Return Address
   ë©”ì„œë“œ ì¢…ë£Œ í›„ ë³µê·€í•  ë°”ì´íŠ¸ì½”ë“œ ì£¼ì†Œ
   
   compute() â†’ add() í˜¸ì¶œ ì‹œ:
   add() Frameì˜ Return Address = compute()ì˜ ë‹¤ìŒ ëª…ë ¹ì–´ ì£¼ì†Œ

3. Exception Handler
   try-catch ë¸”ë¡ ì •ë³´ (Exception Table)
   
   try {
       risky();
   } catch (IOException e) {
       handle(e);
   }
   
   Exception Table:
   from  to   target  type
   0     5    8       IOException
   
   â†’ 0~5ë²ˆ ëª…ë ¹ì–´ì—ì„œ IOException ë°œìƒ ì‹œ 8ë²ˆìœ¼ë¡œ ì í”„
```

---

### 6. StackOverflowError ë°œìƒ ì¡°ê±´

```
ìŠ¤íƒ í¬ê¸° ì œí•œ:
  ê° ìŠ¤ë ˆë“œì˜ ìŠ¤íƒì€ ê³ ì • í¬ê¸° (-Xss í”Œë˜ê·¸)
  ê¸°ë³¸: Linux 1MB, Windows 320KB (JVM ë²„ì „ì— ë”°ë¼ ë‹¤ë¦„)

ì¬ê·€ í˜¸ì¶œ:
  void recurse(int n) {
      if (n == 0) return;
      recurse(n - 1);  // Frame ê³„ì† Push
  }

ìŠ¤íƒ ì‚¬ìš©ëŸ‰:
  Frame 1ê°œ í¬ê¸° â‰ˆ LVA + Operand Stack + Frame Data
  ëŒ€ëµ ìˆ˜ì‹­ ë°”ì´íŠ¸ ~ ìˆ˜ë°± ë°”ì´íŠ¸
  
  ì˜ˆ: Frame 1ê°œ = 100 bytes
      ìŠ¤íƒ í¬ê¸° = 1MB = 1,048,576 bytes
      ìµœëŒ€ Frame ìˆ˜ â‰ˆ 10,000ê°œ
      â†’ ì¬ê·€ ê¹Šì´ 10,000 ì´ˆê³¼ ì‹œ StackOverflowError

ì‹¤ì œ ì¸¡ì •:
  int count = 0;
  void recurse() {
      count++;
      recurse();
  }
  
  -Xss1m: count â‰ˆ 10,000 ~ 15,000
  -Xss512k: count â‰ˆ 5,000 ~ 7,500
  -Xss256k: count â‰ˆ 2,500 ~ 3,750
```

---

## ğŸ’» ì‹¤í—˜ìœ¼ë¡œ í™•ì¸í•˜ê¸°

### ì‹¤í—˜ 1: Frame í¬ê¸°ì™€ ì¬ê·€ ê¹Šì´ ì¸¡ì •

```java
public class StackDepthTest {
    static int depth = 0;
    
    static void recurse() {
        depth++;
        recurse(); // ë¬´í•œ ì¬ê·€
    }
    
    public static void main(String[] args) {
        try {
            recurse();
        } catch (StackOverflowError e) {
            System.out.println("ìµœëŒ€ ì¬ê·€ ê¹Šì´: " + depth);
            System.out.println("ìŠ¤ë ˆë“œ ìŠ¤íƒ í¬ê¸°: " + 
                Runtime.getRuntime().maxMemory() + " bytes");
        }
    }
}
```

```bash
# ë‹¤ì–‘í•œ ìŠ¤íƒ í¬ê¸°ë¡œ ì‹¤í–‰
java -Xss256k StackDepthTest   # ì¶œë ¥: ìµœëŒ€ ê¹Šì´ ~2500
java -Xss512k StackDepthTest   # ì¶œë ¥: ìµœëŒ€ ê¹Šì´ ~5000
java -Xss1m StackDepthTest     # ì¶œë ¥: ìµœëŒ€ ê¹Šì´ ~10000
java -Xss2m StackDepthTest     # ì¶œë ¥: ìµœëŒ€ ê¹Šì´ ~20000

# ì§€ì—­ ë³€ìˆ˜ê°€ ë§ì€ ë©”ì„œë“œ
static void recurseBig() {
    int a, b, c, d, e, f, g, h;  // LVA í¬ê¸° ì¦ê°€
    long l1, l2, l3;              // 64ë¹„íŠ¸ = 2ìŠ¬ë¡¯ì”©
    depth++;
    recurseBig();
}

# Frameì´ ì»¤ì ¸ì„œ ê¹Šì´ ê°ì†Œ
java -Xss1m StackDepthTest  # recurseBig: ~7000 (recurse: ~10000ë³´ë‹¤ ì ìŒ)
```

---

### ì‹¤í—˜ 2: javapë¡œ LVAì™€ Operand Stack í¬ê¸° í™•ì¸

```java
public class StackAnalysis {
    public int compute(int a, int b) {
        int c = a + b;
        int d = c * 2;
        return d;
    }
}
```

```bash
javac StackAnalysis.java
javap -c -verbose StackAnalysis.class

# ì¶œë ¥ì—ì„œ ì£¼ëª©:
# public int compute(int, int);
#   descriptor: (II)I
#   Code:
#     stack=2, locals=4, args_size=3
#             ^^^^^^^^^^^ 
#     0: iload_1
#     1: iload_2
#     2: iadd
#     3: istore_3
#     ...

# stack=2:   Operand Stack ìµœëŒ€ ê¹Šì´ 2
# locals=4:  LVA ìŠ¬ë¡¯ 4ê°œ (this, a, b, c, d)
# args_size=3: ë§¤ê°œë³€ìˆ˜ 3ê°œ (this, a, b)
```

---

### ì‹¤í—˜ 3: JFRë¡œ ìŠ¤íƒ ì‚¬ìš©ëŸ‰ í”„ë¡œíŒŒì¼ë§

```bash
# JFR ê¸°ë¡
java -XX:StartFlightRecording=filename=stack.jfr,settings=profile MyApp

# JMCë¡œ ë¶„ì„
# "Thread" â†’ "Thread Dump" íƒ­
# ê° ìŠ¤ë ˆë“œì˜ ìŠ¤íƒ ê¹Šì´, ë©”ì„œë“œ í˜¸ì¶œ íŠ¸ë¦¬ í™•ì¸

# ë˜ëŠ” jstack ëª…ë ¹ì–´
jstack <pid> > thread_dump.txt

# thread_dump.txt ë¶„ì„:
# "main" #1 prio=5 os_prio=0 tid=0x... nid=0x... runnable
#   at com.example.Service.process(Service.java:42)
#   at com.example.Controller.handle(Controller.java:15)
#   at ...
#   â† ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ = Frame ìŠ¤íƒ
```

---

## âš¡ ì‹¤ë¬´ ì„íŒ©íŠ¸

### ì ì • ìŠ¤íƒ í¬ê¸° ì„¤ì •

```
ê¸°ë³¸ê°’ (1MB):
  ëŒ€ë¶€ë¶„ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì¶©ë¶„
  ì¬ê·€ ê¹Šì´ ~10,000 í—ˆìš©

ìŠ¤íƒ í¬ê¸°ë¥¼ ì¤„ì—¬ì•¼ í•˜ëŠ” ê²½ìš°:
  ìŠ¤ë ˆë“œ ìˆ˜ê°€ ë§¤ìš° ë§ì€ ê²½ìš° (1000+)
  
  ì˜ˆ: 1000 ìŠ¤ë ˆë“œ, ê° ìŠ¤íƒ 1MB
      â†’ 1GB ë©”ëª¨ë¦¬ ì†Œë¹„ (ìŠ¤íƒë§Œ)
  
  í•´ê²°: -Xss512k ë˜ëŠ” -Xss256k
  ë‹¨, ê¹Šì€ ì¬ê·€ê°€ ì—†ì–´ì•¼ í•¨

ìŠ¤íƒ í¬ê¸°ë¥¼ ëŠ˜ë ¤ì•¼ í•˜ëŠ” ê²½ìš°:
  StackOverflowError ë°œìƒ
  ê¹Šì€ ì¬ê·€ ë˜ëŠ” ë³µì¡í•œ ë©”ì„œë“œ ì²´ì¸
  
  ì˜ˆ: JSON íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ê¹Šì€ ì¤‘ì²© êµ¬ì¡°
      XML íŒŒì„œì˜ ì¬ê·€ í˜¸ì¶œ
  
  í•´ê²°: -Xss2m ë˜ëŠ” -Xss4m
  ì£¼ì˜: ìŠ¤ë ˆë“œë‹¹ ë©”ëª¨ë¦¬ ì¦ê°€
```

### ì¬ê·€ë¥¼ ë°˜ë³µë¬¸ìœ¼ë¡œ ë³€í™˜

```java
// âŒ ê¹Šì€ ì¬ê·€ â†’ StackOverflowError ìœ„í—˜
int factorial(int n) {
    if (n <= 1) return 1;
    return n * factorial(n - 1);
}

// âœ… ë°˜ë³µë¬¸ìœ¼ë¡œ ë³€í™˜
int factorial(int n) {
    int result = 1;
    for (int i = 2; i <= n; i++) {
        result *= i;
    }
    return result;
}

// íŠ¸ë ˆì´ë“œì˜¤í”„:
// ì¬ê·€: ì½”ë“œ ê°„ê²°, ì´í•´ ì‰¬ì›€, ìŠ¤íƒ ìœ„í—˜
// ë°˜ë³µ: ì½”ë“œ ê¸¸ì–´ì§, ìŠ¤íƒ ì•ˆì „, ì„±ëŠ¥ ìš°ìˆ˜
```

### Virtual Threadsì™€ ìŠ¤íƒ

```java
// Java 21+ Virtual Thread
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    for (int i = 0; i < 1_000_000; i++) {
        executor.submit(() -> {
            // Virtual ThreadëŠ” ì‘ì€ ìŠ¤íƒ ì‚¬ìš©
            // Platform Thread: 1MB ìŠ¤íƒ
            // Virtual Thread: ìˆ˜ KB ìŠ¤íƒ (ë™ì  í™•ì¥)
        });
    }
}

// 100ë§Œ Virtual Thread ì‹¤í–‰ ê°€ëŠ¥
// Platform Threadë¼ë©´ 1TB ë©”ëª¨ë¦¬ í•„ìš”
// Virtual ThreadëŠ” ìˆ˜ GBë¡œ ì¶©ë¶„
```

---

## ğŸš« í”í•œ ì˜¤í•´

### "ìŠ¤íƒì€ Heapë³´ë‹¤ ë¹ ë¥´ë‹¤"

```
âŒ ì˜ëª»ëœ ì´í•´:
  ìŠ¤íƒ í• ë‹¹ì´ í™ í• ë‹¹ë³´ë‹¤ í•­ìƒ ë¹ ë¥´ë‹¤.

âœ… ì‹¤ì œ:
  "ë¹ ë¥´ë‹¤"ì˜ ì˜ë¯¸ê°€ ë‹¤ë¦„
  
  ìŠ¤íƒ:
  - í• ë‹¹: Bump-the-pointer (í¬ì¸í„° ì´ë™)
  - í•´ì œ: Frame Pop (ìë™, ë©”ì„œë“œ ì¢…ë£Œ ì‹œ)
  - ë™ê¸°í™” ë¶ˆí•„ìš” (ìŠ¤ë ˆë“œë³„ ë…ë¦½ ìŠ¤íƒ)
  
  í™ (TLAB í™œì„±í™” ì‹œ):
  - í• ë‹¹: TLAB ë‚´ Bump-the-pointer (ìŠ¤íƒê³¼ ê°™ì€ ì†ë„)
  - í•´ì œ: GC í•„ìš” (ë¹„ë™ê¸°)
  
  ì‹¤ì œ í• ë‹¹ ì†ë„ëŠ” ë¹„ìŠ·í•¨
  ì°¨ì´ëŠ” ìˆ˜ëª… ê´€ë¦¬ ë°©ì‹
  - ìŠ¤íƒ: ë©”ì„œë“œ ìŠ¤ì½”í”„ (ìë™ í•´ì œ)
  - í™: GCê°€ ê´€ë¦¬
```

### "ì§€ì—­ ë³€ìˆ˜ëŠ” í•­ìƒ ìŠ¤íƒì—ë§Œ ì¡´ì¬í•œë‹¤"

```java
âŒ ì˜ëª»ëœ ì´í•´:
  void foo() {
      int x = 10;  // ìŠ¤íƒ
      Object obj = new Object();  // obj ì°¸ì¡°ë„ ìŠ¤íƒ
  }

âœ… ì‹¤ì œ:
  void foo() {
      int x = 10;           // LVA[1]ì— ê°’ 10 ì €ì¥ (ìŠ¤íƒ)
      Object obj = new Object();
      //    ^^^ ì°¸ì¡°(ì£¼ì†Œ)ëŠ” LVA[2]ì— ì €ì¥ (ìŠ¤íƒ)
      //        ì‹¤ì œ Object ì¸ìŠ¤í„´ìŠ¤ëŠ” í™
  }
  
  Escape Analysis ì˜ˆì™¸:
  JIT ì»´íŒŒì¼ëŸ¬ê°€ ê°ì²´ê°€ ë©”ì„œë“œ ë°–ìœ¼ë¡œ íƒˆì¶œí•˜ì§€ ì•Šìœ¼ë©´
  í™ ëŒ€ì‹  ìŠ¤íƒì— í• ë‹¹ (Scalar Replacement)
  
  void bar() {
      Point p = new Point(1, 2);
      int sum = p.x + p.y;  // pê°€ ë©”ì„œë“œ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°
      // â†’ JITê°€ pë¥¼ ìŠ¤íƒ ì§€ì—­ ë³€ìˆ˜ë¡œ ìµœì í™” ê°€ëŠ¥
  }
```

### "StackOverflowErrorëŠ” ë³µêµ¬ ê°€ëŠ¥í•˜ë‹¤"

```java
âŒ ì˜ëª»ëœ ì´í•´:
  try {
      deepRecursion();
  } catch (StackOverflowError e) {
      // ì—¬ê¸°ì„œ ë³µêµ¬ ê°€ëŠ¥
  }

âœ… ì‹¤ì œ:
  StackOverflowErrorëŠ” Error (Throwableì˜ ì„œë¸Œí´ë˜ìŠ¤)
  Exceptionì´ ì•„ë‹˜
  
  catchëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ:
  - ìŠ¤íƒì´ ì´ë¯¸ ê³ ê°ˆëœ ìƒíƒœ
  - catch ë¸”ë¡ ì‹¤í–‰ ìì²´ê°€ Frame í•„ìš”
  - ë³µêµ¬ ì½”ë“œê°€ ë³µì¡í•˜ë©´ ë˜ ë‹¤ì‹œ StackOverflowError
  
  ê¶Œì¥:
  catchí•´ì„œ ë¡œê¹…ë§Œ í•˜ê³  ì¦‰ì‹œ ì¢…ë£Œ
  ë˜ëŠ” ì•„ì˜ˆ catchí•˜ì§€ ë§ê³  JVMì´ ì¢…ë£Œí•˜ê²Œ ë‘ 
```

---

## ğŸ“Œ í•µì‹¬ ì •ë¦¬

```
JVM ìŠ¤íƒ êµ¬ì¡°
  ìŠ¤ë ˆë“œë‹¹ 1ê°œ ìŠ¤íƒ (ë…ë¦½ì , LIFO)
  ë©”ì„œë“œ í˜¸ì¶œ = Frame Push
  ë©”ì„œë“œ ì¢…ë£Œ = Frame Pop

Stack Frame êµ¬ì„±
  Local Variable Array (LVA): ì§€ì—­ ë³€ìˆ˜ + ë§¤ê°œë³€ìˆ˜ ì €ì¥
  Operand Stack: ë°”ì´íŠ¸ì½”ë“œ ì‹¤í–‰ ì‹œ ì„ì‹œ ë°ì´í„°
  Frame Data: Constant Pool Reference, Return Address, Exception Handler

LVA ì¸ë±ìŠ¤
  ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œ: 0 = this, 1ë¶€í„° ë§¤ê°œë³€ìˆ˜/ì§€ì—­ ë³€ìˆ˜
  static ë©”ì„œë“œ: 0ë¶€í„° ë§¤ê°œë³€ìˆ˜/ì§€ì—­ ë³€ìˆ˜
  long/double: 2ìŠ¬ë¡¯ ì°¨ì§€

Operand Stack
  ë°”ì´íŠ¸ì½”ë“œ ì‹¤í–‰ì˜ ì‘ì—… ê³µê°„
  push/pop ì—°ì‚°ìœ¼ë¡œ ê³„ì‚° ìˆ˜í–‰
  RPN (Reverse Polish Notation) ë°©ì‹

StackOverflowError
  ìŠ¤íƒ í¬ê¸° (-Xss) ì´ˆê³¼ ì‹œ ë°œìƒ
  ì¬ê·€ ê¹Šì´ = ìŠ¤íƒ í¬ê¸° / Frame í¬ê¸°
  ê¸°ë³¸ 1MB: ~10,000 ì¬ê·€ ê¹Šì´

ìŠ¤íƒ í¬ê¸° ì„¤ì •
  ê¸°ë³¸ 1MB: ëŒ€ë¶€ë¶„ ì¶©ë¶„
  ë§ì€ ìŠ¤ë ˆë“œ: -Xss512k ë˜ëŠ” -Xss256k
  ê¹Šì€ ì¬ê·€: -Xss2m ë˜ëŠ” -Xss4m
  Virtual Thread: ë™ì  í™•ì¥, ì‘ì€ ì´ˆê¸° í¬ê¸°
```

---

## ğŸ¤” ìƒê°í•´ë³¼ ë¬¸ì œ

**Q1.** ë©”ì„œë“œì— ì§€ì—­ ë³€ìˆ˜ê°€ 100ê°œ ìˆê³ , ê° ë³€ìˆ˜ê°€ `int` íƒ€ì…ì´ë¼ë©´ LVAëŠ” ìµœì†Œ ëª‡ ìŠ¬ë¡¯ì´ í•„ìš”í•œê°€? `this`, `long` íƒ€ì… ë§¤ê°œë³€ìˆ˜ë¥¼ ê³ ë ¤í•´ ê³„ì‚°í•˜ë¼.

**Q2.** Operand Stackì˜ ìµœëŒ€ ê¹Šì´ëŠ” ì–´ë–»ê²Œ ê²°ì •ë˜ëŠ”ê°€? ì»´íŒŒì¼ëŸ¬ê°€ ë°”ì´íŠ¸ì½”ë“œë¥¼ ìƒì„±í•  ë•Œ ì–´ë–¤ ë¶„ì„ì„ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ”ê°€?

**Q3.** `-Xss128k`ë¡œ ì„¤ì •í•œ ì„œë²„ì—ì„œ ê°„í—ì ìœ¼ë¡œ `StackOverflowError`ê°€ ë°œìƒí•œë‹¤. ìŠ¤íƒì„ ëŠ˜ë¦¬ëŠ” ëŒ€ì‹  ì½”ë“œë¥¼ ìˆ˜ì •í•´ í•´ê²°í•˜ëŠ” ë°©ë²• 3ê°€ì§€ë¥¼ ì œì‹œí•˜ë¼.

> ğŸ’¡ **í•´ì„¤**
>
> **Q1.** ì¸ìŠ¤í„´ìŠ¤ ë©”ì„œë“œì´ê³  `long` íƒ€ì… ë§¤ê°œë³€ìˆ˜ 1ê°œë¼ë©´: `this` (1ìŠ¬ë¡¯) + `long` ë§¤ê°œë³€ìˆ˜ (2ìŠ¬ë¡¯) + `int` ì§€ì—­ ë³€ìˆ˜ 100ê°œ (ê° 1ìŠ¬ë¡¯) = 103ìŠ¬ë¡¯. static ë©”ì„œë“œë¼ë©´ `this`ê°€ ì—†ì–´ 102ìŠ¬ë¡¯. ì‹¤ì œë¡œëŠ” javacê°€ ìŠ¤ì½”í”„ ë¶„ì„ì„ í•´ì„œ ë™ì‹œì— ì‚´ì•„ìˆì§€ ì•Šì€ ë³€ìˆ˜ë“¤ì€ ê°™ì€ ìŠ¬ë¡¯ì„ ì¬ì‚¬ìš©í•˜ë¯€ë¡œ ìµœì í™”ë  ìˆ˜ ìˆë‹¤.
>
> **Q2.** ì»´íŒŒì¼ëŸ¬ê°€ ëª¨ë“  ë°”ì´íŠ¸ì½”ë“œ ì‹¤í–‰ ê²½ë¡œë¥¼ ë¶„ì„í•´ ê° ì‹œì ì˜ ìŠ¤íƒ ê¹Šì´ë¥¼ ê³„ì‚°í•˜ê³ , ìµœëŒ€ê°’ì„ `max_stack`ìœ¼ë¡œ ì„¤ì •í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `iadd`ëŠ” 2ê°œ pop í›„ 1ê°œ pushí•˜ë¯€ë¡œ ê¹Šì´ -1, ë³µì¡í•œ ìˆ˜ì‹ `(a+b)*(c+d)`ëŠ” ì¤‘ê°„ì— ìµœëŒ€ 4ê°œê¹Œì§€ ìŒ“ì¼ ìˆ˜ ìˆë‹¤. ë¶„ê¸°ê°€ ìˆìœ¼ë©´ ëª¨ë“  ê²½ë¡œì˜ ìµœëŒ€ê°’ì„ ì·¨í•œë‹¤. ì´ ê°’ì´ Frame ìƒì„± ì‹œ Operand Stack í¬ê¸°ë¥¼ ê²°ì •í•œë‹¤.
>
> **Q3.** ë°©ë²• 1: ì¬ê·€ë¥¼ ë°˜ë³µë¬¸ìœ¼ë¡œ ë³€í™˜. ì˜ˆë¥¼ ë“¤ì–´ ê¹Šì´ ìš°ì„  íƒìƒ‰(DFS)ì„ ëª…ì‹œì  ìŠ¤íƒ(`Stack<Node>`)ìœ¼ë¡œ êµ¬í˜„. ë°©ë²• 2: ê¼¬ë¦¬ ì¬ê·€ ìµœì í™” ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì½”ë“œ ë³€ê²½ (ë‹¨, JVMì€ ê¸°ë³¸ì ìœ¼ë¡œ ê¼¬ë¦¬ ì¬ê·€ ìµœì í™” ì•ˆ í•˜ë¯€ë¡œ ì‹¤ì œë¡œëŠ” ë°˜ë³µë¬¸ ë³€í™˜). ë°©ë²• 3: ì‘ì—…ì„ ì—¬ëŸ¬ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ ì¬ê·€ ê¹Šì´ ì œí•œ. ì˜ˆë¥¼ ë“¤ì–´ íŠ¸ë¦¬ ìˆœíšŒ ì‹œ ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜, ë¹„ë™ê¸° ì²˜ë¦¬ë¡œ ì½œ ìŠ¤íƒ ë¶„ë¦¬.

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [JVMS Â§2.5.2 â€” Java Virtual Machine Stacks](https://docs.oracle.com/javase/specs/jvms/se21/html/jvms-2.html#jvms-2.5.2)
- [JVMS Â§2.6 â€” Frames](https://docs.oracle.com/javase/specs/jvms/se21/html/jvms-2.html#jvms-2.6)
- [JEP 444 â€” Virtual Threads](https://openjdk.org/jeps/444)

---

<div align="center">

**[â¬…ï¸ ì´ì „: TLAB (Thread-Local Allocation Buffer)](./02-tlab-thread-local-allocation.md)** | **[ë‹¤ìŒ: Method Area & Metaspace â¡ï¸](./04-method-area-metaspace.md)**

</div>
